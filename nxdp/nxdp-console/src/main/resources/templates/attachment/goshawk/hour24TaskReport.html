<html xmlns:th="http://www.thymeleaf.org">

<!-- BEGIN HEAD -->
<head>
<title th:fragment="html-title">24小时任务报表</title>
<style type="text/css">
.table {
}
.table th {
  white-space: nowrap;
  text-align: center;
}
.table td {
  white-space: nowrap;
  text-align: center;
}
.table .text-left {
  text-align: left;
}
</style>
</head>
<head th:include="common :: common-html-header"></head>
<!-- END HEAD -->




<body>
<!-- BEGIN HEADER -->
<div th:replace="common :: common-page-header"></div>
<!-- END HEADER -->

<!-- BEGIN PAGE CONTAINER -->
<div class="page-container">
    <div class="page-content">
        <!-- BEGIN PAGE HEAD -->
        <div class="container">
            <ul class="page-breadcrumb breadcrumb">
                <li>
                    <a href="/goshawk/index">苍鹰系统</a>
                    <i class="fa fa-circle"></i>
                </li>
                <li>
                    <a>YARN管理</a>
                    <i class="fa fa-circle"></i>
                </li>
                <li class="active">24小时任务数统计
                </li>
            </ul>

            <div class="portlet light bordered">
                <div class="portlet-title">
                    <div class="caption font-green-sharp">
                        <span>24小时任务数统计</span>
                    </div>
                    <div class="actions">
                    </div>
                </div>
				
                <div class="portlet-body">
                <form role="form" class="alert alert-success alert-borderless">
                        <div class="row form-group">
                            <div class="col-md-2">
                                <label class="control-label">日期：</label>
                                <div class="input-group date" id="runDate">
                                    <input type="text" class="form-control" id="taskDate">
                                    <span class="input-group-btn">
              <button class="btn default date-set" type="button"><i class="fa fa-calendar"></i></button>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                            <input type="hidden" id="reprotType" value="0">
                                <label class="control-label">&nbsp;&nbsp;&nbsp;</label>
                                <span class="input-group-btn">
                                        <button type="button" onclick="get24HourTaskCount(-1)" class="btn green-haze">查询</button>
                                </span>
                            </div>
                        </div>
                        <!-- <div class="row form-group">
                        </div> -->
                    </form>
                    
                    <div class="col-md-13" id="chart3_div">
		            <div class="portlet light">
		              <div class="portlet-title">
		                <div class="caption font-dark">
		                  <span class="caption-subject bold uppercase font-red-sunglo">24小时任务数统计</span>
		                  <!-- <span class="caption-helper">当日上线任务运行状态</span> -->
		                </div>
		                <div class="actions">
		                  <a href="javascript:get24HourTaskCount(0)" data-value="showDPRunJobStatus:3" class="btn btn-circle btn-default btn-sm"> 全部 </a>
                  		  <a href="javascript:get24HourTaskCount(1)" data-value="showDPRunJobStatus:2" class="btn btn-circle btn-default btn-sm"> 任务类型 </a>
                  		  <a href="javascript:get24HourTaskCount(2)" data-value="showDPRunJobStatus:1" class="btn btn-circle btn-default btn-sm"> 运行类型 </a>
		                </div>
		              </div>
		              <div class="portlet-body">
		                  <div id="hour24TaskCount" class="CSSAnimationChart"></div>
		              </div>
		            </div>
		            <!-- END PORTLET-->
		            </div>
                    <!-- end form -->
                    <!-- <div class="">
                    <table class="table table-hover table-advance table-striped" id="dataTable" style="width:100%;">
                        <thead>
                        <tr>
                            <th>日期</th>
                            <th>用户目录</th>
                            <th>总量(Byte)</th>
                            <th>增量(Byte)</th>
                        </tr>
                        </thead>
                        <tbody id="tableTbody">
                        
                        </tbody>
                    </table>
                    </div> -->
                </div>
                
               <!--  <div class="portlet-body" id="portlet-body">
                    <div class="col-md-13" id="chart3_div">
		            <div class="portlet light">
		              <div class="portlet-title">
		                <div class="caption font-dark">
		                  <span class="caption-subject bold uppercase font-red-sunglo">各组子目录数据量统计</span>
		                  <span class="caption-helper">当日上线任务运行状态</span>
		                </div>
		                <div class="actions">
		                  <a href="javascript:getLittleCountData(0)"  class="btn btn-circle btn-default btn-sm" onclick="getCountData()">总量</a>
		                  <a href="javascript:getLittleCountData(1)"  class="btn btn-circle btn-default btn-sm">增量</a>
		                </div>
		              </div>
		              <div class="portlet-body">
		                  <div id="hdfsFileDetail" class="CSSAnimationChart"></div>
		              </div>
		            </div>
		            END PORTLET
		            </div>
                    end form
                    <div class="">
                    <table class="table table-hover table-advance table-striped" id="dataTable2" style="width:100%;">
                        <thead>
                        <tr>
                            <th>日期</th>
                            <th>用户</th>
                            <th>总量(Byte)</th>
                            <th>增量(Byte)</th>
                            <th>middata(Byte)</th>
                            <th>middata增量(Byte)</th>
                            <th>rawdata(Byte)</th>
                            <th>rawdata增量(Byte)</th>
                            <th>resultdata(Byte)</th>
                            <th>resultdata增量(Byte)</th>
                            <th>warehouse(Byte)</th>
                            <th>warehouse增量(Byte)</th>
                        </tr>
                        </thead>
                        <tbody id="tableTbody2">
                        </tbody>
                    </table>
                    </div>
                </div> -->
            </div>

        </div>
        <!-- END PAGE CONTENT -->
    </div>
</div>
<!-- END PAGE CONTAINER -->



<!-- BEGIN PRE-FOOTER -->
<div th:include="common :: common-page-footer"></div>
<!-- END PRE-FOOTER -->
<!-- BEGIN FOOTER -->

<!-- END FOOTER -->

</body>


<!-- BEGIN JAVASCRIPT -->
<div th:replace="common :: common-html-javascripts"></div>
<!-- END JAVASCRIPT -->

<!-- <script src="/assets/page/scripts/workshop/task-list-33b267f1ff.min.js" type="text/javascript"></script> -->


<!-- END BODY -->
<script src="/assets/global/scripts/echarts.common.min.js" type="text/javascript"></script>
<script th:inline="javascript">

//折线图
function getBrokenLineOption(xData,legendData,seriesData){
	  var option = {
			    tooltip: {
			        trigger: 'axis'
			    },
			    legend: {
			        data:legendData
			    },
			    grid: {
			        left: '3%',
			        right: '4%',
			        bottom: '3%',
			        containLabel: true
			    },
			    toolbox: {
			        feature: {
			            saveAsImage: {}
			        }
			    },
			    xAxis: {
			        type: 'category',
			        boundaryGap: false,
			        data: xData
			    },
			    yAxis: {
			        type: 'value'
			    },
			    series: seriesData
			};
	  return option;
}

    jQuery(document).ready(function() {
        /* TaskList.init({
            contextPath: '',
            userId: [[${user.id}]]
        }); */
        //initJobLevel();
        get24HourTaskCount(0);
    	//initFirstTable();
        jQuery().datepicker && ($("#runDate").datepicker({
            rtl: Metronic.isRTL(),
            orientation: "right",
            autoclose: !0,
            format: "yyyy-mm-dd"
        }).on("changeDate", function (a) {
            
        }), $("#runDate").datepicker("setDate", "-0d"))
    });
    
    
    var oTable;
    var initTables = function() {
    	var table = $('#dataTable');
        oTable = table.DataTable({
          'serverSide' : true,
          'ordering' : false,
          'searching' : false,
          'scrollX' : true,
          'ajax' : {
            url : '/goshawk/search-colddata.do',
            data : function(d){
              d.columns = null;
              //d.search = null;
              d['isDel'] = $("#cold_status").val();
              d['coldDir'] = $("#cold_dir").val();
            },
            dataSrc : function(rs) {
              return rs.data;
            },
          },
          'columns' : [
            { data: null,
              render: function(data, type, full, meta){
                var innerHtml = "<input type='checkbox'  data-set='" + data.id + "' data-status='"+data.is_del+"' class='checkboxes' style='width: 15px; height: 15px;' />";
                return innerHtml;
              }
            },
            { data : null,
              className : 'text-left',
              render: function(data, type, full, meta) {
                var dir = data.dir;
                return dir;
              }
            },
            { data : "atimeStr"},
            { data : null,
              render: function(data, type, full, meta) {
                var innerHtml = "";
                if (data.is_del == 0) {
                  innerHtml = "<span class='label bg-yellow'>未删除</span>"
                } else if (data.is_del == 2) {
                  innerHtml = "<span class='label bg-green'>删除成功</span>"
                } else if (data.is_del == 3) {
                  innerHtml = "<span class='label bg-red' style='cursor: pointer' title='错误提示："+data.error+"' >删除失败</span>"
                } else if (data.is_del == 1) {
                  innerHtml = "<span class='label bg-grey'>删除中</span>"
                }
                return innerHtml;
              }
            },
          ]
        });
        
      };
      
      //0未删除 1删除中 2 删除成功 3删除失败
      var initJobLevel = function() {
    	    self.jobLevels = [{id: -1, text: '全部'}, {id: 0, text: '未删除'}, {id: 1, text: '删除中'},
    	                    {id: 2, text: '删除成功'},{id: 3, text: '删除失败'}];
    	    $('#cold_status').select2({
    	      minimumResultsForSearch:-1,
    	      "language": {
    	        "noResults": function() {
    	          return "无搜索结果";
    	        }
    	      },
    	      placeholder: '选择冷数据状态',
    	      data: self.jobLevels
    	    }).on('change', function(item) {
    	      /* self.searchForm.jobLevel = $(this).val();
    	      self.oTable.ajax.reload(); */
    	    });
    	    $('#cold_status').val(-1).trigger('change');
    	  };
    	  
    var clickedAll = function(obj){
    	
    	var isChe = $(obj).attr("checked");
    	if(isChe == "checked"){
    		//选中所有
    		$(".checkboxes").each(function(){
    			$(this).attr("checked", 'checked');
    		});
    	}else{
    		//取消选中
    		$(".checkboxes").each(function(){
    			$(this).prop("checked", false);
    		});
    	}
    }
    
    
    var xData = {};
    var teamData = {};
    var yNumData = {};
    var yIncreData = {};
    
    function initFirstTable(){
    	var data = {};
    	data.menuType = 1;
    	$.ajax({
			"type":"POST",
			"url":"/goshawk/searchHdfsFileNum.do",
			"data":data,
			success:function (data) {
				//加载列表数据
				var tableStr = "";
				for(var i = 0;i<data.data.length;i++){
					var tableData = data.data[i];
					tableStr += "<tr>";
					tableStr += "<td>"+tableData.dt+"</td>";
					tableStr += "<td><a href='javascript:getTeamHdfsDetail(\""+tableData.dt+"\",\""+tableData.dir+"\")'>"+tableData.dir+"</a></td>";
					tableStr += "<td>"+tableData.fileNum+"</td>";
					tableStr += "<td>"+tableData.incre+"</td>";
					tableStr += "</tr>";
				}
				$("#tableTbody").html(tableStr);
				$('#dataTable').dataTable({
					"sScrollX":"100%",
		            "sScrollXInner":"100%",
					"bLengthChange":true, 
					"bSort":false ,
				  	"bPaginage":true,
				  	"bFilter":true,
				  	"paging" : true,
				  	"info":true,
				  	"scrollY":"400px"
				});
				
				xData = data.xData;
				teamData = data.teamData;
				yNumData = data.yNumData;
				yIncreData = data.yIncreData;
				//加载图表
				initFirstReport(1);
			},
			error:function() {
				alert("未知错误");
			}
		});
    	
    }
    
    
    function initFirstReport(type){
    	var dataList = {};
    	
    	if(type == 1){
    		//全量数据
    		dataList = yNumData;
    		
    	}else if(type == 2){
    		//增量数据
    		dataList = yIncreData;
    	}
    	
    	var myChart3 = echarts.init(document.getElementById('littleDir')); 
		var seriesData = new Array();
		for(var i=0;i<dataList.length;i++){
			var mrData = {};
			mrData.name = teamData[i];
			mrData.type = "line";
			//mrData.barGap = 0;
			mrData.data = dataList[i];
			seriesData[i] = mrData;
		}
		var option3 = getBrokenLineOption(xData,teamData,seriesData);
		myChart3.setOption(option3);
    }
    
    var table2;
    function getTeamHdfsDetail(maxDate,dirStr){
    	$("#portlet-body").show();
    	//hdfsFileDetail
    	var data = {};
    	data.dirStr = dirStr;
    	data.maxDate = maxDate;
    	data.menuType = 1;
    	$.ajax({
			"type":"POST",
			"url":"/goshawk/searchHdfsFileNumDetail.do",
			"data":data,
			success:function (data) {
				//加载列表数据
				var tableStr = "";
				for(var i = 0;i<data.tableData.length;i++){
					var tableData = data.tableData[i];
					tableStr += "<tr>";
					tableStr += "<td>"+tableData.dt+"</td>";
					tableStr += "<td>"+tableData.dir+"</td>";
					tableStr += "<td>"+tableData.totalNum+"</td>";
					tableStr += "<td>"+tableData.totalIncr+"</td>";
					tableStr += "<td>"+tableData.num0+"</td>";
					tableStr += "<td>"+tableData.incNum0+"</td>";
					tableStr += "<td>"+tableData.num1+"</td>";
					tableStr += "<td>"+tableData.incNum1+"</td>";
					tableStr += "<td>"+tableData.num2+"</td>";
					tableStr += "<td>"+tableData.incNum2+"</td>";
					tableStr += "<td>"+tableData.num3+"</td>";
					tableStr += "<td>"+tableData.incNum3+"</td>";
					tableStr += "</tr>";
				}
				
				$("#tableTbody2").html(tableStr);
				if(table2==undefined){
					table2 = $('#dataTable2').dataTable({
						"sScrollX":"100%",
			            "sScrollXInner":"100%",
						"bLengthChange":true, 
						"bSort":false ,
					  	"bPaginage":true,
					  	"bFilter":true,
					  	"paging" : true,
					  	"info":true,
					  	"scrollY":"400px"
					});
				}
								
				var myChart3 = echarts.init(document.getElementById('hdfsFileDetail')); 
				var seriesData = new Array();
				for(var i=0;i<data.yData.length;i++){
					var mrData = {};
					mrData.name = data.subDirData[i];
					mrData.type = "line";
					//mrData.barGap = 0;
					mrData.data = data.yData[i];
					seriesData[i] = mrData;
				}
				var option3 = getBrokenLineOption(data.xData,data.subDirData,seriesData);
				myChart3.setOption(option3);
				location.href = "#portlet-body";
			},
			error:function() {
				alert("未知错误");
			}
		});
    }
    
    //获取柱状图-多柱子
    function getColumnarsOption(titleStr,colorList,xData,seriesData,unitStr){
  	  var option = {
  			  //color: colorList,//, '#e5323e'
  			  title : {
  			        text: titleStr,
  			        //subtext: '纯属虚构',
  			        //x:'center'
  			    },
  			    tooltip : {
  			        trigger: 'axis',
  			        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
  			            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
  			        }
  			    },
  			    grid: {
  			        left: '3%',
  			        right: '4%',
  			        bottom: '3%',
  			        containLabel: true
  			    },
  			    xAxis : [
  			        {
  			            type : 'category',
  			            data : xData,
  			            axisTick: {
  			                alignWithLabel: true
  			            }
  			        }
  			    ],
  			    yAxis : [
  			        {
  			            type : 'value',
  			            axisLabel:{
  				        	formatter:unitStr
  				        }
  			        }
  			    ],
  			    series : seriesData
  			};
  	  return option;
    }
    
    function get24HourTaskCount(reprotType){
    	debugger
      var taskDate = $("#taskDate").val();
      if(reprotType == -1){
    	  reprotType = $("#reprotType").val();
      }else{
    	  $("#reprotType").val(reprotType);
      }
      
  	  $.ajax({
  			"type":"POST",
  			"data":{
  				reprotType:reprotType,
  				reportDate:taskDate
  			},
  			"url":"/goshawk/get24HourTaskData.do",
  			success:function (res) {
  				var data = res.data;
  				var myChart13 = echarts.init(document.getElementById('hour24TaskCount'));
  				var seriesData = new Array();
  				
  				if(reprotType==0){
  					//全部任务统计
  					var mrData = {};
  					mrData.name = "所有任务";
  					mrData.type = "bar";
  					mrData.barGap = 0;
  					mrData.data = data.dataList;
  					seriesData[0] = mrData;
  					var option13 = getColumnarsOption("全部任务["+data.reportDate+"]","",data.xData,seriesData,'{value}');
  				}else if(reprotType == 1){
  					//任务类型
  					var mrData = {};
  					mrData.name = "MR任务";
  					mrData.type = "bar";
  					mrData.barGap = 0;
  					mrData.data = data.dataList;
  					seriesData[0] = mrData;
  					
  					var spData = {};
  					spData.name = "SPARK任务";
  					spData.type = "bar";
  					spData.barGap = 0;
  					spData.data = data.dataList2;
  					seriesData[1] = spData;
  					
  					var option13 = getColumnarsOption("任务类型["+data.reportDate+"]","",data.xData,seriesData,'{value}');
  				}else if(reprotType == 2){
  					//运行类型
  					var mrData = {};
  					mrData.name = "调度任务";
  					mrData.type = "bar";
  					mrData.barGap = 0;
  					mrData.data = data.dataList;
  					seriesData[0] = mrData;
  					
  					var spData = {};
  					spData.name = "非调度任务";
  					spData.type = "bar";
  					spData.barGap = 0;
  					spData.data = data.dataList2;
  					seriesData[1] = spData;
  					
  					var option13 = getColumnarsOption("运行类型["+data.reportDate+"]","",data.xData,seriesData,'{value}');
  				}
  				
  				myChart13.setOption(option13);
  			},
  			error:function() {
  				alert("未知错误");
  			}
  		});
  	}
    

</script>
</html>


<html xmlns:th="http://www.thymeleaf.org">

<!-- BEGIN HEAD -->
<head th:include="common :: common-html-header"></head>
<head>
    <title th:fragment="html-title">元数据-设计元数据</title>
    <link href="/assets/global/plugins/x-editable/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet"
          type="text/css">
</head>
<!-- END HEAD -->

<body>
<!-- BEGIN HEADER -->
<div th:replace="common :: common-page-header"></div>
<!-- END HEADER -->

<div class="page-container">
    <div class="page-content">
        <div class="container">
            <!-- BEGIN PAGE BREADCRUMB -->
            <ul class="breadcrumb">
                <li><a href="#">元数据</a><span class="divider">/</span></li>
                <li><a href="/metadata/hive-table/list">元数据列表</a><span class="divider">/</span></li>
                <li class="active">设计元数据</li>
            </ul>
            <!-- END PAGE BREADCRUMB -->
            <!-- BEGIN PANEL -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <span class="panel-title">设计新表</span>
                    <div class="pull-right" style="display:inline-block;">
                        <span class="help-block"><a
                                href="http://dashen.zhuanspirit.com/pages/viewpage.action?pageId=32212210"
                                target="_blank">操作说明书</a></span>
                    </div>
                    <!-- <div class="pull-right" style="margin-top: -6px;">
                      <a id="executeCreateHiveTableBtn" href="javascript:;" class="btn btn-circle btn-default" th:if="${table != null && table.status == 0}">执行建表</a>
                    </div> -->
                </div>
                <!-- BEGIN -->
                <div class="panel-body">
                    <form class="form-horizontal" id="form">
                        <input id="hiddenId" name="id" th:value="${table?.id}" type="hidden">
                        <input id="hiddenTableId" name="tableId" th:value="${table?.tableId}" type="hidden">
                        <input name="createTime" th:value="${#dates.format(table?.createTime,'yyyy-MM-dd HH:mm:ss')}"
                               type="hidden"/>
                        <input name="modifyTime" th:value="${#dates.format(table?.modifyTime,'yyyy-MM-dd HH:mm:ss')}"
                               type="hidden"/>
                        <input name="status" th:value="${table?.status}" type="hidden"/>
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-xs-1 control-label">服务器</label>
                                <div class="col-xs-5">
                                    <select class="form-control selectpicker show-tick" data-live-search="true" data-none-selected-text="服务器"
                                            data-size="5" id="server" name="serverId"
                                            style="width: 100%;" title="服务器">
                                        <option selected="selected" value="1">default</option>
                                    </select>
                                </div>
                                <label class="col-xs-1 control-label">数据库</label>
                                <div class="col-xs-5">
                                    <select class="form-control selectpicker show-tick" data-live-search="true" data-size="5"
                                            id="db" name="dbId" style="width: 100%;" title="数据库">
                                        <option th:attr="data-dbCode=${db.code},data-dbDescription=${db.description}" th:each="db : ${dbs}" th:text="${db.name}"
                                                th:value="${db.id}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-xs-1 control-label">表名</label>
                                <div class="col-xs-11">
                                    <div class="col-xs-1"
                                         style="padding-left: 0;padding-right: 0;margin-left: 0;margin-right: 0;">
                                        <label class="control-label pull-right" id="tableNamePrefix"></label>
                                    </div>
                                    <div class="col-xs-11"
                                         style="padding-left: 0;padding-right: 0;margin-left: 0;margin-right: 0;">
                                        <div class="col-xs-8"
                                             style="padding-left: 0;padding-right: 0;margin-left: 0;margin-right: 0;">
                                            <input class="form-control" id="tableName" name="name" style="width: 100%;margin-left:0;margin-right:0;"
                                                   th:value="${table?.name}"
                                                   type="text">
                                        </div>
                                        <div class="col-xs-4" style="padding-left: 0;padding-right: 0;">
                                            <div class="col-xs-5" style="padding-left: 0;padding-right: 0;">
                                                <select class="form-control selectpicker show-tick" data-live-search="true"
                                                        data-size="5"
                                                        id="tableUpdateType" name="updateType" title="更新方式">
                                                    <option th:each="ut : ${tableUpdateTypes}" th:text="${ut.name}"
                                                            th:value="${ut.code}"></option>
                                                </select>
                                            </div>
                                            <div class="col-xs-5" style="padding-left: 0;padding-right: 0;">
                                                <select class="form-control selectpicker show-tick" data-live-search="true"
                                                        data-size="5"
                                                        id="tablePartition" name="partition" title="分区方式">
                                                    <option th:each="p : ${tablePartitions}" th:text="${p.name}"
                                                            th:value="${p.code}"></option>
                                                </select>
                                            </div>
                                            <div class="col-xs-2">
                                                <i class="fa fa-question-circle" data-html="true"
                                                   data-placement="top" data-toggle="tooltip"
                                                   title="<pre>后两个输入框分别是更新方式和分区方式，它们是表名的一部分。</pre>"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-xs-1 control-label">存储格式</label>
                                <div class="col-xs-2">
                                    <select class="form-control selectpicker show-tick" data-live-search="true"
                                            data-size="5" id="storageFormat"
                                            name="storageFormat" style="width: 100%;">
                                        <option th:each="sf : ${tableStorageFormats}" th:text="${sf.name}"
                                                th:value="${sf.code}"></option>
                                    </select>
                                </div>
                                <div class="col-xs-9" id="charSeparatorDiv" style="display:none;">
                                    <div class="col-xs-3">
                                        <label class="col-xs-12 control-label">自定义分隔符</label>
                                    </div>
                                    <div class="col-xs-9" style="padding-left:0;padding-right:0;">
                                        <input class="form-control" id="charSeparator" name="charSeparator" placeholder="自定义分割符"
                                               style="width:100%;" type="text" value="\t"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-xs-1 control-label">描述信息</label>
                                <div class="col-xs-11">
                                    <textarea class="form-control" id="tableDescription" name="description"
                                              th:text="${table?.description}"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-xs-1 control-label"></label>
                                <div class="col-xs-11">
                                    <label class="checkbox-inline">
                                        <input data-toggle="toggle" id="modifyLocation" type="checkbox">
                                        <span>更改存储路径</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-horizontal">
                            <div class="form-group" id="locationDiv" style="display:none;">
                                <label class="col-xs-1 control-label">location</label>
                                <div class="col-xs-11">
                                    <textarea class="form-control" id="location" name="location"
                                              style="width:100%;"
                                              th:text="${table == null?locationPrefix:table?.location}"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-xs-1 control-label">标签</label>
                                <div class="col-xs-3">
                                    <select class="form-control selectpicker show-tick" data-live-search="true" data-size="5"
                                            id="lebelId" name="labelId" style="width: 100%;" title="标签">
                                        <option th:attr="data-level=${l.level}" th:each="l : ${tableLebels}" th:text="${l.name}"
                                                th:value="${l.id}"></option>
                                    </select>
                                </div>
                                <label class="col-xs-1 control-label">子标签</label>
                                <div class="col-xs-3">
                                    <select class="form-control selectpicker show-tick" data-live-search="true"
                                            data-size="5" id="childLebelId"
                                            name="childLabelId" style="width: 100%;" title="子标签">
                                        <option th:attr="data-level=${cl.level}" th:each="cl : ${childTableLebels}"
                                                th:text="${cl.name}" th:value="${cl.id}"></option>
                                    </select>
                                </div>
                                <div class="col-xs-4">
                                    <label>没有找到标签分类？</label>
                                    <a href="javascript:;" id="openLebelModalBtn">点此添加标签分类</a>
                                </div>
                            </div>
                        </div>
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-xs-1 control-label">表分组</label>
                                <div class="col-xs-3">
                                    <select class="form-control selectpicker show-tick" data-live-search="true" data-size="5"
                                            id="tableGroup" name="group" style="width: 100%;">
                                        <option th:each="g : ${tableGroups}" th:text="${g.name}"
                                                th:value="${g.code}"></option>
                                    </select>
                                </div>
                                <label class="col-xs-1 control-label">表层级</label>
                                <div class="col-xs-3">
                                    <select class="form-control" disabled="disabled" id="tableLevel" name="level"
                                            style="width: 100%;">
                                        <option th:each="l : ${tableLevels}" th:text="${l.name}"
                                                th:value="${l.code}"></option>
                                    </select>
                                </div>
                                <label class="col-xs-1 control-label">负责人</label>
                                <div class="col-xs-3">
                                    <input id="creatorId" name="creatorId" th:value="${currentUser.id}" type="hidden"/>
                                    <input class="form-control" disabled id="creatorName" name="creator"
                                           th:value="${currentUser.trueName}" type="text"/>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table data-height="300" data-show-footer="false" data-striped="true" id="workTable"></table>
                        <div class="row" style="text-align: center;">
                            <button class="btn btn-success" id="saveAndCreateBtn" type="button">保存</button>
                            <button class="btn btn-success" id="executeCreateTableBtn" style="display:none;"
                                    type="button">执行建表
                            </button>
                            <!-- <button id="saveAsDraftBtn" type="button" class="btn btn-info" th:if="${table == null ||table?.status == 0}">保存草稿</button> -->
                            <button class="btn btn-warning" id="insertColumnBtn" type="button">新增字段</button>
                            <button class="btn btn-warning" id="insertColumnsByDDLBtn" type="button">快速生成字段(DDL)
                            </button>
                        </div>
                    </div>
                </div>
                <!-- END -->
            </div>
            <!-- END PANEL -->
        </div>
    </div>
</div>

<!-- 右键菜单 -->
<ul class="dropdown-menu" id="workTableContextMenu">
    <li data-item="up"><a>上移</a></li>
    <li data-item="down"><a>下移</a></li>
    <li data-item="delete"><a>删除</a></li>
    <li data-item="ddl"><a>建表SQL(DDL)</a></li>
</ul>


<!-- 标签 -->
<div class="modal container fade" data-backdrop="static" data-keyboard="false" id="lebelModal">
    <div class="modal-header">
        <h4 class="modal-title">标签管理</h4>
        <div class="pull-right">
            <button class="btn btn-warning" id="insertLebelBtn" type="button">添加标签</button>
        </div>
    </div>
    <div class="modal-body">
        <table class="table table-hover table-advance table-striped" data-detail-view="true" data-show-footer="false"
               data-striped="true" id="lebelTable"></table>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary" id="closeLebelModal" type="button">关闭</button>
        <!-- <button type="button" class="btn btn-primary" id="saveAndColseLebelModal">确定</button> -->
    </div>
</div>


<!-- 建表SQL -->
<div class="modal container fade" data-backdrop="static" data-keyboard="false" id="sqlModal">
    <div class="modal-header">
        <h4 class="modal-title">SQL</h4>
    </div>
    <div class="modal-body">
        <div style="overflow: visible;">
            <textarea disabled="disabled" id="hiveSqlTextarea" readonly="readonly"
                      style="width: 100%;height: 300px;"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-info" id="closeSqlModal" type="button">取消</button>
        <button class="btn btn-success" id="executeSqlAndColseSqlModal" type="button">执行</button>
    </div>
</div>


<!-- 手工录入SQL -->
<div class="modal container fade" data-backdrop="static" data-keyboard="false" id="DDLModal">
    <div class="modal-header">
        <h4 class="modal-title">DDL</h4>
        <span class="help-block">说明：输入HIVE SQL帮助开发者快速生成表名、表备注、字段、字符类型、注释等信息。</span>
    </div>
    <div class="modal-body">
        <div style="overflow: visible;">
            <textarea id="DDLTextarea" style="width: 100%;height: 300px;"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-info" id="closeDDLModal" type="button">取消</button>
        <button class="btn btn-success" id="executeSqlAndColseDDLModal" type="button">确定</button>
    </div>
</div>


<!-- BEGIN PRE-FOOTER -->
<div th:include="common :: common-page-footer"></div>
<!-- END PRE-FOOTER -->
</body>
<!-- END BODY -->

<!-- BEGIN JAVASCRIPT -->
<div th:replace="common :: common-html-javascripts"></div>
<!-- END JAVASCRIPT -->


<script src="/assets/global/plugins/x-editable/bootstrap3-editable/js/bootstrap-editable.min.js"
        type="text/javascript"></script>
<script src="/assets/global/plugins/bootstrap-table/extensions/contextmenu/bootstrap-table-contextmenu.min.js"
        type="text/javascript"></script>
<script src="/assets/global/plugins/bootstrap-table/extensions/editable/bootstrap-table-editable.min.js"
        type="text/javascript"></script>

<script th:inline="javascript">
var dbChangeAction = function($select){
  var dbCode = $select.find('option:selected').attr('data-dbCode');
  var dbDescription = $select.find('option:selected').attr('data-dbDescription');
  $('#tableNamePrefix').html(dbCode == undefined ? '' : dbCode + '_');
  $('#tableLevel').find('option').each(function(i,obj){
    if($(this).text() == dbDescription){
      $(this).attr('selected','selected');
    }
  })
  //创建表的时候，rawdb和dim存储格式只能是textfile其他的优先选择parquet
  if(dbCode == 'rawdb' || dbCode == 'dim'){
    $('#storageFormat').find('[value=2]').attr('disabled',true);
    $('#storageFormat').selectpicker('val', '1');
  }else{
    $('#storageFormat').find('[value=2]').attr('disabled',false);
    $('#storageFormat').selectpicker('val', '2');
  }
  var table = [[${table}]];
  if(table != null){
    $('#storageFormat').selectpicker('val', table.storageFormat);
    $('#charSeparator').val(table.charSeparator);
  }
  $('.selectpicker').selectpicker('refresh');
  $('#storageFormat').trigger('change');
}

var buildForm = function(){
  //校验普通表单
  var dbId = $('#db').val();
  if(dbId == 0){
    bootbox.alert('请选择数据库');
    return false;
  }
  var tableName = $.trim($('#tableName').val());
  if(tableName == ''){
    bootbox.alert('请填写表名');
    return false;
  }
  var description = $.trim($('#tableDescription').val());
  if(description == ''){
    bootbox.alert('请填写描述信息');
    return false;
  }
  //校验table
  var rows = $('#workTable').bootstrapTable('getData');
  if(rows.length == 0){
    bootbox.alert('请填写表字段数据');
    return false;
  }
  var partitionArray = new Array();//统计分区字段
  var error = null;
  $.each(rows,function(i,row){
    var prefix = '第'+(i+1)+'行';
    if($.isEmptyObject(row)){
      error = prefix +'无数据';
      return false;
    }
    if($.isEmptyObject(row.columnName) || $.trim(row.columnName) == ''){
      error = prefix + '字段名为空';
      return false;
    }
    if($.isEmptyObject(row.columnCname) || $.trim(row.columnCname) == ''){
      error = prefix + '字段中文名为空';
      return false;
    }
    if($.isEmptyObject(row.columnType) || $.trim(row.columnType) == ''){
      error = prefix + '字段类型为空';
      return false;
    }
    // if($.isEmptyObject(row.columnLength) || $.trim(row.columnLength) == ''){
    //   error = prefix + '字段长度为空';
    //   return false;
    // }
    if($.isArray(row.columnPartitionMarker) && row.columnPartitionMarker.length > 0){
      if(row.columnPartitionMarker[0] == 'true'){
        partitionArray.push(row);
      }
    }
  })
  if(error != null){
    bootbox.alert(error);
    return false;
  }
  //校验分区字段的个数是否正确
  var tablePartitionText = $('#tablePartition').find('option:selected').text();
  if(tablePartitionText == '_0p'){//不能有分区字段
    if(partitionArray.length != 0){
      bootbox.alert(tablePartitionText+'表示不允许有分区字段');
      return false;
    }
  }else if(tablePartitionText == '_1h'){//必须存在dt和hour分区字段且dt在hour之前
    var condition = '';
    $.each(partitionArray,function(i,p){
      if(p.columnName == 'dt' || p.columnName == 'hour'){
        condition += p.columnName;
        if(i != partitionArray.length -1){
          condition += ',';
        }
      }
    })
    if('dt,hour' != condition){
      bootbox.alert(tablePartitionText+'表示必须存在dt和hour分区字段且dt字段在hour前面');
      return false;
    }
  }else{
    var condition = '';
    $.each(partitionArray,function(i,p){
      if(p.columnName == 'dt'){
        condition = p.columnName;
        /* if(i != partitionArray.length -1){
          condition += ',';
        } */
        return false;
      }
    })
    if('dt' != condition){
      bootbox.alert(tablePartitionText+'表示必须存在dt分区字段');
      return false;
    }
  }
  //表单
  $('#server').attr('disabled',false);
  $('#db').attr('disabled',false);
  $('#tableName').attr('disabled',false);
  var form = $('#form').serialize()
  +'&modifyLocation='+($('#modifyLocation').prop('checked')?1:0)
  +'&level='+$('#tableLevel').val()
  +'&type='+($('#importFromOther').prop('checked')?1:0)
  +'&json='+JSON.stringify(rows);
  $('#server').attr('disabled',true);
  $('#db').attr('disabled',true);
  $('#tableName').attr('disabled',true);
  console.log(form);
  return form;
}

//执行建表
var executeCreateHiveTable = function(){
  $.post('/metadata/hive-table/build-hive-table-sql.do',{id : $('#hiddenId').val()},function(resp){
    if(resp.status == 'error'){
      bootbox.alert(resp.data);
      return false;
    }
    $('#hiveSqlTextarea').text('');
    $('#hiveSqlTextarea').text(resp.data);
    $('#sqlModal').modal('show');
  })
}


$(function(){
  $.fn.editable.defaults.mode = 'inline';
  //数据库
  $('#db').change(function(){
    dbChangeAction($(this));
    /* var dbId = $(this).val();
    var dbCode = $(this).find('option:selected').attr('data-dbCode');
    $('#tableNamePrefix').html(dbCode == undefined ? '' : dbCode + '_');
    $('#tableLevel').find('option').each(function(i,obj){
      if($(this).text() == dbCode){
        $(this).attr('selected','selected');
      }
    }) */
  });
  //标签
  $('#lebelId').change(function(){
    var lebelId = $(this).val();
    $.get('/metadata/label/children',{parentId : lebelId},function(resp){
      if(resp.status == 'error'){
        bootbox.alert(resp.data);
        return false;
      }
      var optionsHtml = '';
      $.each(resp.data,function(i,obj){
        optionsHtml += '<option value="'+obj.id+'">'+obj.name+'</option>';
      })
      $('#childLebelId').empty();
      $('#childLebelId').append(optionsHtml);
      $('#childLebelId').selectpicker('refresh')
    })
  })
  //添加字段
  $('#insertColumnBtn').click(function(){
    /* var row = {};
    var firstCellInLastRow = $('#workTable tbody tr').last().find('td').eq(0);
    var rowId = 1;
    if(new RegExp('\\d+').exec(firstCellInLastRow.text()) != null){
      rowId = parseInt(firstCellInLastRow.text()) + 1;
    }
    $('#workTable thead tr th').each(function(i,col){
      if($(this).attr('data-field') == 'columnId'){
        row[$(this).attr('data-field')] = rowId;
      }
      else{
        row[$(this).attr('data-field')] = null;
      }
    }); */
    var rows = $('#workTable').bootstrapTable('getData');
    var complete = true;
    $.each(rows,function(i,row){
      if($.isEmptyObject(row)){
        complete = false;
        return false;
      }
    })
    if(!complete){
      bootbox.alert('请完善字段信息');
      return false;
    }
    $('#workTable').bootstrapTable('insertRow', {index : rows.length, row : {"columnName":null,"columnCname":null,"columnType":null,"columnLength":null,"columnDescription":null}});
    $('#workTable').bootstrapTable('scrollTo', 'bottom');
  });
  
  $('#workTable').bootstrapTable({
    contextMenu : '#workTableContextMenu',
    onContextMenuItem : function(row,$el){
      var data = $('#workTable').bootstrapTable('getData');
      var currentRowIndex = $.inArray(row,data);
      if($el.data("item") == "up"){//上移
        if(currentRowIndex == 0){
          return false;
        }
        var upperRow = data[currentRowIndex - 1];
        $('#workTable').bootstrapTable('remove', {field : 'columnName',values : [upperRow.columnName]});
        $('#workTable').bootstrapTable('insertRow', {index : currentRowIndex, row : upperRow});
      }
      else if($el.data("item") == "down"){//下移
        if(currentRowIndex == data.length - 1){
          return false;
        }
        var underRow = data[currentRowIndex + 1];
        $('#workTable').bootstrapTable('remove', {field : 'columnName',values : [underRow.columnName]});
        $('#workTable').bootstrapTable('insertRow', {index : currentRowIndex, row : underRow});
      }
      else if($el.data("item") == "delete"){//删除
        $('#workTable').bootstrapTable('remove', {field : 'columnName',values : [row.columnName]});
      }
      else if($el.data("item") == "ddl"){//ddl
        $('#DDLModal').modal('show');
      }
    },
    columns : [
      {
        field : 'columnName',
        title : '字段名',
        editable : {
          type : 'text',
          validate : function(value){
            if($.trim(value) == ''){
              return '字段名不允许为空';
            }
          },
          display : function(value){
            if(value == 'undefined'){
              value = '';
            }
            $(this).text(value);
          }
        }
      },
      {
        field : 'columnCname',
        title : '字段中文名',
        editable : {
          type : 'text',
          validate : function(value){
            if($.trim(value) == ''){
              return '字段中文名不允许为空';
            }
          }
        },
      },
      {
        field : 'columnType',
        title : '字段类型',
        editable : {
          type : 'text',
          validate : function(value){
            if($.trim(value) == ''){
              return '字段类型不允许为空';
            }
          }
        }
      },
      {
        field : 'columnLength',
        title : '字段长度',
        editable : {
          type : 'text',
          validate : function(value){
            if(value.match(new RegExp('^\\d+$')) == null){
              return '字段长度只能为数字';
            }
          }
        }
      },
      {
        field : 'columnNullMarker',
        title : '允许为NULL',
        editable : {
          type : 'checklist',
          source : {'true':'NULL'},
          display : function(value,sourceData){
            var key;
            if($.isArray(value) && value.length > 0){
              key = value[0];
            }else if(value == true){
              key = 'true';
            }
            var items = $.fn.editableutils.itemsByValue(key, sourceData);
            if(items.length){
              $(this).html($.fn.editableutils.escape(items[0].text));
            }else{
              $(this).empty();
            }
          }
        }
      },
      {
        field : 'columnPartitionMarker',
        title : '分区',
        editable : {
          type : 'checklist',
          source : {'true':'分区'},
          display : function(value,sourceData){
            var key;
            if($.isArray(value) && value.length > 0){
              key = value[0];
            }else if(value == true){
              key = 'true';
            }
            var items = $.fn.editableutils.itemsByValue(key, sourceData);
            if(items.length){
              $(this).html($.fn.editableutils.escape(items[0].text));
            }else{
              $(this).empty();
            }
          }
        }
      }
    ]
  });
  
  $('#openLebelModalBtn').click(function(){
    loadLebelTable($('#lebelTable'),0,1);
    $('#lebelModal').modal('show');
  })
  
  $('#closeLebelModal').click(function(){
    $('#lebelTable').bootstrapTable('destroy');
    $('#lebelModal').modal('hide');
  })
  
  $('#saveAndCloseLebelModal').click(function(){
    
    $('#lebelTable').bootstrapTable('destroy');
    $('#lebelModal').modal('hide');
  })
  
  var loadLebelTable = function($table,parentId,level){
    $table.bootstrapTable({
      ajax : function(request){
        $.get('/metadata/label/list',{parentId : parentId,level : level},function(data){
          request.success({row : data});
          $table.bootstrapTable('load',data);
        })
      },
      //url : '/metadata/label/list?parentId='+parentId+'&level='+level,
      columns : [
        /* {
          field : 'id',
          title : 'ID'
        }, */
        {
          field : 'name',
          title : '标签名',
          editable : {
            type : 'text',
            validate : function(value){
              if($.trim(value) == ''){
                return '标签名不允许为空';
              }
            }
          }
        },
        {
          field : 'level',
          title : '类别',
          formatter : function(value,row,index){
            var html = null;
            if(value == 1){
              html = '标签';
            }
            if(value == 2){
              html ='子标签';
            }
            return html;
          }
        },
        {
          field : 'operate',
          title : '操作',
          events : {
            'click .event-saveLebel' : function(e,value,row,index){
              $.post('/metadata/label/save-or-update',row,function(resp){
                if(resp.status == 'error'){
                  bootbox.alert(resp.data);
                  return false;
                }
                toastr.success('保存成功', '成功');
                $table.bootstrapTable('updateRow',{
                  index : index,
                  row : resp.data
                });
                //刷新页面的标签下拉框
                $.get('/metadata/label/list',{parentId : parentId,level : level},function(data){
                  var html = '';
                  $.each(data,function(i,lebel){
                    html += '<option value="'+lebel.id+'">'+lebel.name+'</option>';
                  });
                  var $lebelSelect;
                  if(level == 1){
                    $lebelSelect = $('#lebelId');
                  }else if(level ==2){
                    $lebelSelect = $('#childLebelId');
                  }
                  $lebelSelect.empty();
                  $lebelSelect.append(html);
                  $('.selectpicker').selectpicker('refresh');
                })
              })
            },
            'click .event-deleteLebel' : function(e,value,row,index){
              if(row.id != null){
                $.post('/metadata/label/delete',{id : row.id},function(resp){
                  if(resp.status == 'error'){
                    bootbox.alert(resp.data)
                    return false;
                  }
                  toastr.success('删除成功', '成功');
                })
              }
              $table.bootstrapTable('hideRow',{index : index});
            },
            'click .event-addSubLebel' : function(e,value,row,index){
              if(row.id == null){
                bootbox.alert('无法添加子标签')
                return false;
              }
              var currentPageData = $('#subLebelTable_'+row.id).bootstrapTable('getData');
              var rowData = {
                  id : null,
                  name : null,
                  parentId : row.id,
                  level : 2
              };
              $('#subLebelTable_'+row.id).bootstrapTable('insertRow', {index : currentPageData.length, row : rowData});
              $('#subLebelTable_'+row.id).bootstrapTable('scrollTo', 'bottom');
            }
          },
          formatter : function(value,row,index){
            var html = '';
            html += '<button type="button" class="btn btn-success event-saveLebel">保存</button>';
            html += '<button type="button" class="btn btn-danger event-deleteLebel">删除</button>';
            if(row.level == 1){
              html += '<button type="button" class="btn btn-warning event-addSubLebel">添加子标签</button>';
            }
            return html;
          }
        }
      ],
      onPostBody : function(){
        $table.bootstrapTable('expandAllRows');
      },
      onExpandRow : function(index, row, $detail){
        loadLebelTable($detail.html('<table id="subLebelTable_'+row.id+'"></table>').find('table'),row.id == null ? 0 : row.id,row.level + 1);
      }
    });
  }
  
  //添加标签
  $('#insertLebelBtn').click(function(){
    var rows = $('#lebelTable').bootstrapTable('getData');
    $('#lebelTable').bootstrapTable('insertRow', {index : rows.length, row : {id : null,name : null,parentId : 0,level : 1}});
    $('#lebelTable').bootstrapTable('scrollTo', 'bottom');
  });
  
  //保存草稿
  $('#saveAsDraftBtn').click(function(){
    var form = buildForm();
    if(typeof(form) == 'boolean'){
      return false;
    }
    $.post('/metadata/hive-table/save-as-draft',form,function(resp){
      if(resp.status == 'error'){
        bootbox.alert(resp.data)
        return false;
      }
      bootbox.confirm({
        message: "草稿保存成功，是否返回到HIVE表列表？",
        buttons: {
          cancel: {
            label: '取消',
            className: 'btn-info'
          },
          confirm: {
            label: '确定',
            className: 'btn-success'
          }
        },
        callback: function (result) {
          if(result){
            window.location.href = '/metadata/hive-table/list';
          }
        }
      });
    })
  })
  
  //保存&执行建表
  $('#saveAndCreateBtn').click(function(){
    var form = buildForm();
    if(typeof(form) == 'boolean'){
      return false;
    }
    $.post('/metadata/hive-table/save.do',form,function(resp){
      if(resp.status == 'error'){
        bootbox.alert(resp.data)
        return false;
      }
      //隐藏域赋值
      $('#hiddenId').val(resp.data.id);
      $('#hiddenTableId').val(resp.data.tableId);
      $('#form input[name="createTime"]').val(resp.data.createTime);
      $('#form input[name="modifyTime"]').val(resp.data.modifyTime);
      $('#form input[name="status"]').val(resp.data.status);
      $('#executeCreateTableBtn').show();
      bootbox.alert('保存成功，现在可以执行建表操作了');
      /* bootbox.confirm('保存成功，是否返回列表页？', function(result){ 
        if(result){
          window.location.href = '/metadata/hive-table/list';
        }
      }); */
      /* bootbox.confirm({
        message: "保存成功，是否执行建表？若取消则跳转到HIVE表列表页",
        buttons: {
          cancel: {
            label: '取消',
            className: 'btn-info'
          },
          confirm: {
            label: '确定',
            className: 'btn-success'
          }
        },
        callback: function (result) {
          if(!result){
            window.location.href = '/metadata/hive-table/list';
          }else{//执行建表
            executeCreateHiveTable();
          }
        }
      }); */
    })
  })
  //点击执行建表按钮
  $('#executeCreateTableBtn').click(function(){
    executeCreateHiveTable();
  })
  //点击SQL模态框的取消按钮
  $('#closeSqlModal').click(function(){
    $('#sqlModal').modal('hide');
  })
  $('#closeDDLModal').click(function(){
    $('#DDLModal').modal('hide');
  })
  $('#insertColumnsByDDLBtn').click(function(){
    $('#DDLModal').modal('show');
  })
  //点击SQL模态框的执行按钮
  $('#executeSqlAndColseSqlModal').click(function(){
    $.post('/metadata/hive-table/execute-hive-table-sql.do',{
      id : $('#hiddenId').val(),
      sql : $('#hiveSqlTextarea').text()
    },function(resp){
      if(resp.status == 'error'){
        bootbox.alert(resp.data)
        return false;
      }
      bootbox.confirm({
        message: "执行建表成功，是否跳转到HIVE表列表页？",
        buttons: {
          cancel: {
            label: '取消',
            className: 'btn-info'
          },
          confirm: {
            label: '确定',
            className: 'btn-success'
          }
        },
        callback: function (result) {
          if(result){
            window.location.href = '/metadata/hive-table/list';
          }
        }
      });
    })
  })
  $('#executeSqlAndColseDDLModal').click(function(){
    $.post('/metadata/hive-table/parseSQL.do',{sql : $('#DDLTextarea').val()},function(re){
      if(re.status != 'ok'){
        bootbox.alert('Parse error:'+re.message);
        return false;
      }
      console.log(re.data);
      $.each(re.data.fields,function(i,column){
        var rows = $('#workTable').bootstrapTable('getData');
        $('#workTable').bootstrapTable('insertRow', {index : rows.length, row : {"columnName":column.name,"columnCname":column.comment,"columnType":column.type,"columnLength":null,"columnDescription":column.comment}});
        $('#workTable').bootstrapTable('scrollTo', 'bottom');
      })
      $.each(re.data.partitions,function(i,column){
        var rows = $('#workTable').bootstrapTable('getData');
        $('#workTable').bootstrapTable('insertRow', {index : rows.length, row : {"columnName":column.name,"columnCname":column.comment,"columnType":column.type,"columnLength":null,"columnDescription":column.comment,"columnPartitionMarker":new Array("true")}});
        $('#workTable').bootstrapTable('scrollTo', 'bottom');
      })
      $('#tableName').val(re.data.name);
      $('#tableDescription').text(re.data.comment);
      if(re.data.location && re.data.location != ''){
        $('#modifyLocation').prop('checked',true).change();
        $('#location').text(re.data.location);
      }
      if(re.data.fileFormat && re.data.fileFormat != ''){
        $('#storageFormat').find('option[text="'+re.data.fileFormat+'"]').attr('selected',true);
        $('#storageFormat').selectpicker('refresh')
      }
      $('#DDLModal').modal('hide');
    });
    /* $.post('/metadata/hive-table/parse-columns-from-ddl.do',{
      dialect: 'hive',
      ddl: $('#DDLTextarea').val()
    },function(data){
      if(data.status == 'ok'){
        var columns = data.data;
        $.each(columns,function(i,column){
          var rows = $('#workTable').bootstrapTable('getData');
          console.log(rows);
          $('#workTable').bootstrapTable('insertRow', {index : rows.length, row : {"columnName":column.name,"columnCname":column.alias,"columnType":column.type,"columnLength":column.length,"columnDescription":null}});
          $('#workTable').bootstrapTable('scrollTo', 'bottom');
        })
      }else{
        bootbox.alert('SQL解析失败'+data.data);
      }
      $('#DDLModal').modal('hide');
    }) */
  })
  //更改location
  $('#modifyLocation').change(function() {
    if($(this).prop('checked')){
      $('#locationDiv').show();
    }else{
      $('#locationDiv').hide();
    }
  })
  //
  $('#storageFormat').change(function(){
    var data = $(this).val();
    if(data == '1'){
      $('#charSeparatorDiv').show();
    }
    if(data == '2'){
      $('#charSeparatorDiv').hide();
    }
  })
  
  
  //加载页面
  var table = [[${table}]];
  console.log(table);
  if(table != null){
    $('#server').selectpicker('val',table.serverId);
    $('#db').selectpicker('val',table.dbId);
    $('#tableUpdateType').selectpicker('val',table.updateType);
    $('#tablePartition').selectpicker('val',table.partition);
    $('#lebelId').selectpicker('val',table.lebelId);
    $('#childLebelId').selectpicker('val',table.childLebelId);
    $('#tableGroup').selectpicker('val',table.group);
    $('#creatorId').val(table.creatorId);
    $('#creatorName').val(table.creator);
    $('#workTable').bootstrapTable('load', JSON.parse(table.json));
    //判断是否更改路径
    if(table.modifyLocation != 0){
      $('#modifyLocation').bootstrapToggle('on');
    }
    $('#server').attr('disabled',true).next('button').css('background-color','#dbdbdb');
    $('#db').attr('disabled',true).next('button').css('background-color','#dbdbdb');
    $('#tableName').attr('disabled',true);
    //执行建表可见
    $('#executeCreateTableBtn').show();
  }
  //初始化联动
  dbChangeAction($('#db'));
})

</script>
</html>
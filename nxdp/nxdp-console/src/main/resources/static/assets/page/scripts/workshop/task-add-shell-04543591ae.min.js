var TaskAdd = function() {
  var self = $(this);
  $.ajaxSetup({
    async : false
  });
  String.prototype.startWith = function(str) {
    var reg = new RegExp("^" + str);
    return reg.test(this);
  }

  String.prototype.endWith = function(str) {
    var reg = new RegExp(str + "$");
    return reg.test(this);
  }

  var isNullOrEmpty = function(strVal) {
    if (strVal == '' || strVal == null || strVal == undefined) {
      return true;
    } else {
      return false;
    }
  };

  var initUserList = function() {
    self.userList = new Array();
    $.post(self.contextPath + '/user/api/list-user', function(data, status) {
      _.each(data.userList, function(user) {
        if (self.userId == user.id) {
          self.userList.push({
            id : user.id,
            text : user.trueName + "-" + user.userName,
            selected : true
          });
          return;
        } else {
          self.userList.push({
            id : user.id,
            text : user.trueName + "-" + user.userName,
            selected : false
          });
        }
      });
      $('#selUser').select2({
        "language" : {
          "noResults" : function() {
            return "无搜索结果";
          }
        },
        placeholder : '选择用户',
        data : self.userList
      }).on('change', function(item) {
      });

      $('#selUser').val(self.userId).trigger('change');

    });
  };

  var initReceiverList = function() {
    self.receiverList = new Array();
    $.post(self.contextPath + '/user/api/list-user', function(data, status) {
      _.each(data.userList, function(user) {
        if (self.userId == user.id) {
          self.receiverList.push({
            id : user.id,
            text : user.trueName + "(" + user.userName + ")",
            selected : true
          });
          return;
        } else {
          self.receiverList.push({
            id : user.id,
            text : user.trueName + "(" + user.userName + ")",
            selected : false
          });
        }
      });

      $('#receiver').select2({
        data : self.receiverList,
        multiple : true,
      });

      $('#receiver').val(self.userId).trigger('change');
    });
  };

  var initServerList = function() {
    // server_type-存储类型(2-hive)，local_type-应用类型(2-数据仓库)
    var type = $('#hidType').val();
    var params;

    // shell脚本
    params = {
      serverType : 2,
      localType : 2
    };
    self.serverList = new Array();
    $.post(self.contextPath + '/dev/task/api/list-hdp-clusters', params, function(data, status) {
      _.each(data.serverConfig, function(server) {
        self.serverList.push({
          id : server.id,
          text : server.clusterName,
          selected : false
        });
      });
      $('#server').select2({
        "language" : {
          "noResults" : function() {
            return "无搜索结果";
          }
        },
        placeholder : '选择服务器',
        data : self.serverList
      }).on('change', function(item) {
        /*
         * self.searchForm.userId = $(this).val(); self.oTable.ajax.reload();
         */
      });
      $('#server').val('2').trigger('change');
    });
  };

  var initFileUpload = function() {
    $.ajaxSetup({
      async : true
    });
    $("#jobFile").fileinput({
      language : 'zh',
      showPreview : false,
      showUpload : true,
      uploadUrl : self.contextPath + '/dev/task/uploadFile',
      allowedFileExtensions : ["jar", "py", "sh"],
      elErrorContainer : "#errorBlock"
    });

    $('#jobFile').on("fileuploaded", function(e, data) {
      var res = data.response;
      if (res.result == 'true') {
        $('#filePath').val(res.filePath);
        $('#fileName').val(res.fileName);
        $('#newFileName').val(res.newFileName);
        tryParseJobName();
        toastr["success"]("文件上传成功.", "提示");
        $('#fileUploadState').html(res.fileName + ' 上传成功');
        // 0-代表失败或没上传，1-代表成功
        $('#uploadFlag').val(1);
      } else if (res.result == 'tooBig') {
        toastr["error"]("上传文件太大,请重新新上传", "错误");
        $('#uploadFlag').val(0);
      } else {
        toastr["error"](res.errorMsg, "错误");
        $('#uploadFlag').val(0);
      }
    });

  };

  var tryParseJobName = function() {
    if (!$('#checkDefaultName').is(':checked')) {
      return;
    }
    $('#jobName').val(parseJobName());
  }

  var parseJobName = function() {

    var filename = $('#fileName').val();

    if (!filename) {
      return '';
    }
    var i = filename.lastIndexOf('/');
    if (i != -1) {
      filename = filename.substring(i + 1);
    }

    if (filename.endWith('.jar')) {
      // 如果是jar包单独处理
      filename = filename.replace('.jar', '');
    } else {
      filename = $.trim(filename.split(/\./)[0]);
    }

    return filename;
  }

  // task config validation
  var handleValidationTaskConfig = function() {
    // for more info visit the official plugin documentation:
    // http://docs.jquery.com/Plugins/Validation

    var taskConfigForm = $('#taskConfig');
    var alertInfo = $('.alertInfo');
    var error = $('.alert-danger', alertInfo);
    var success = $('.alert-success', alertInfo);

    taskConfigForm.validate({
      errorElement : 'span', // default input error message container
      errorClass : 'help-block help-block-error', // default input error message
      // class
      focusInvalid : false, // do not focus the last invalid input
      ignore : "", // validate all fields including form hidden input
      rules : {
        jobName : {
          required : true
        },
        description : {
          required : true
        },
        server : {
          required : true
        },
        hadoopQueue : {
          required : true
        }
      },

      messages : { // custom messages for radio buttons and checkboxes
        membership : {
          required : "Please select a Membership type"
        },
        service : {
          required : "Please select  at least 2 types of Service",
          minlength : jQuery.validator.format("Please select  at least {0} types of Service")
        }
      },

      errorPlacement : function(error, element) { // render error placement for
        // each input type
        if (element.parent(".input-group").size() > 0) {
          error.insertAfter(element.parent(".input-group"));
        } else if (element.attr("data-error-container")) {
          error.appendTo(element.attr("data-error-container"));
        } else if (element.parents('.radio-list').size() > 0) {
          error.appendTo(element.parents('.radio-list').attr("data-error-container"));
        } else if (element.parents('.radio-inline').size() > 0) {
          error.appendTo(element.parents('.radio-inline').attr("data-error-container"));
        } else if (element.parents('.checkbox-list').size() > 0) {
          error.appendTo(element.parents('.checkbox-list').attr("data-error-container"));
        } else if (element.parents('.checkbox-inline').size() > 0) {
          error.appendTo(element.parents('.checkbox-inline').attr("data-error-container"));
        } else {
          error.insertAfter(element); // for other inputs, just perform default
          // behavior
        }
      },

      invalidHandler : function(event, validator) { // display error alert on
        // form submit
        success.hide();
        error.show();
        Metronic.scrollTo(error, -200);
      },

      highlight : function(element) { // hightlight error inputs
        $(element).closest('.form-group').addClass('has-error'); // set error
        // class to
        // the control
        // group
      },

      unhighlight : function(element) { // revert the change done by hightlight
        $(element).closest('.form-group').removeClass('has-error'); // set error
        // class to
        // the
        // control
        // group
      },

      success : function(label) {
        label.closest('.form-group').removeClass('has-error'); // set success
        // class to the
        // control group
      },

      submitHandler : function(form) {
        success.show();
        error.hide();
        form.submit(); // submit the form
      }

    });
  }

  var enableDefaultName = function() {
    $('#checkDefaultName').iCheck('check');
  }

  var renderTask = function() {
    self.editing = !!$('#hidId').val();
    if (!self.editing) {
      $('#taskTitle').html('新建SHELL脚本');
      enableDefaultName();
      return;
    }
    $.ajax({
      type : 'POST',
      url : self.contextPath + '/dev/task/api/fetch-task',
      data : {
        "id" : $('#hidId').val()
      },
      success : function(result) {
        if (result.status == 'ok') {
          self.task = result.task;
          initEditing();
        } else {
          toastr["error"]("获取任失败.", "提示");
        }
      },
      error : function() {
        toastr["error"]("获取任务失败.", "提示");
      }
    });
  }
  var initEditing = function() {
    console.log(self.task);
    writeRelationDataBack(self.task);
    var taskDetails = $.parseJSON(self.task.details);

    $('#jobName').val(self.task.jobName);
    $('#description').val(self.task.description);
    $('#hidType').val(self.task.type);
    // initServerList();
    $('#taskTitle').html('修改SHELL脚本');
    $('#server').val(taskDetails.serverId).trigger("change");
    $('#selUser').val(self.task.userId).trigger('change');
    $('#receiver').val(taskDetails.receiver).trigger('change');

    // file
    $('#filePath').val(taskDetails.filePath);
    $('#fileName').val(taskDetails.fileName);
    $('#fileUploadState').html(taskDetails.fileName);
    $('#newFileName').val(taskDetails.newFileName);

    // SHELL参数
    $('#otherArgs').val(taskDetails.otherArgs);

    // default name
    if ($('#jobName').val() == parseJobName()) {
      enableDefaultName();
    }

    // scheduler, dependencies
    var scheduler = taskDetails.scheduler;
    var dependencies = taskDetails.dependencies;
    self.taskScheduler.loadScheduler(scheduler);
    // loadDependencies(dependencies);

  }

  var initSave = function() {
    $('#viewTask').click(function() {
      if (!self.editing) {
        toastr["error"]("任务不存在.", "提示");
      } else {
        self.viewJobUrl = self.contextPath + '/scheduler/task/detail?schedulerId=' + $('#hidId').val();
        window.location.href = self.viewJobUrl;
      }
    });

    $('#saveTask').click(function() {

      var error = function(msg) {
        toastr["error"](msg, "提示");
        return false;
      };

      var val = function(selector) {
        return $.trim($(selector).val());
      };

      var jobName = val('#jobName');

      var fileName = val('#fileName');
      if (isNullOrEmpty(fileName)) {
        error("文件未上传或者上传失败");
        return false;
      }

      var data = {
        'jobName' : jobName,
        'type' : $('#hidType').val(),
        'userId' : val('#selUser'),
        'description' : $('#description').val(),
        'outputMode' : $('#taskConfig input[name="outputMode"]:checked').val(),
        'outputModeValue' : $('#taskConfig input[name="outputMode"]:checked').val() == 1 ? $('#taskConfig select[name="outputModeValue"]').val() : $('#taskConfig input[name="outputModeValue"]').val(),
      };

      if (!$('#taskConfig').validate().form()) {
        return false;
      }

      if (!$('#scheduleConfig').validate().form()) {
        return false;
      }

      var details = {};
      // file
      $.extend(details, {
        fileName : val('#fileName'),
        newFileName : val('#newFileName'),
        filePath : val('#filePath'),
        uploadFlag : val('#uploadFlag'),
        serverId : val('#server'),
        out: packRelationData(),
      });
      // SHELL参数
      $.extend(details, {
        otherArgs : val('#otherArgs')
      });

      // scheduler, dependencies
      var scheduler = self.taskScheduler.validateScheduler();
      var dependencies = $('#dependencyJobIds').val();

      $.extend(details, {
        scheduler : scheduler,
        dependencies : dependencies
      });

      data['details'] = JSON.stringify(details);

      // id
      if (self.editing) {
        data['id'] = $('#hidId').val();
      }
      console.log(data);
      $.post(self.contextPath + '/dev/task/api/save-file-job', data, function(result) {
        if (result.status != 'ok') {
          toastr.error(result.msg);
          return;
        }
        toastr['success'](self.editing ? '修改成功' : '保存成功', '提示');

        if (!self.editing) {
          $('#hidId').val(result.id);
          self.editing = true;
        }
        refreshHistory();

      }, 'json');
    });

  }

  var initJobHistory = function() {
    var table = $('#tblHistory');
    self.tblHistory = table.DataTable({
      "bProcessing" : true,
      "language" : {
        "emptyTable" : "无结果",
        "lengthMenu" : "每页&nbsp; _MENU_ &nbsp;项",
        "search" : "查找：",
        "processing" : "正在加载...",
        "info" : "显示 _START_ 到 _END_ 共 _TOTAL_ 条记录",
        "infoEmpty" : "显示  0  到  0 共  0 条记录"
      },
      "info" : false,
      "ordering" : false,
      "paging" : false,
      "searching" : false,
      "serverSide" : false,
      "ajax" : {
        url : self.contextPath + '/dev/task/api/fetch-file-history',
        type : 'POST',
        data : function(d) {
          d.columns = null;
          d.search = null;
          d['id'] = $('#hidId').val(); // self.searchForm.jobName;
        },
        "dataSrc" : function(rs) {
          if (!rs.list) {
            rs.list = [];
          }
          return rs.list;
        },
      },
      "columns" : [{
        data : "updateTime"
      }, {
        data : "operatorName"
      }, {
        data : "fileName"
      }, {
        data : null,
        render : function(data, type, full, meta) {
          var downloadUrl = self.contextPath + '/dev/task/downloadFile?fileName=' + data.filepath + '&realFileName=' + data.fileName;
          return '<a href="' + downloadUrl + '" class="downloadInNewWindow">下载</a>';
        }
      }],
    });

    $('#tblHistory_processing').hide();

    var tableWrapper = jQuery('#tblHistory_wrapper');
  }

  var refreshHistory = function() {
    self.tblHistory.ajax.reload();
  }

  return {

    init : function(opts) {
      self.contextPath = opts.contextPath;
      self.userId = opts.userId;
      self.taskScheduler = opts.taskScheduler;
      initUserList();
      initReceiverList();
      initFileUpload();
      initServerList();
      handleValidationTaskConfig();
      renderTask();
      initJobHistory();
      initSave();
    },
    fetchSql : function(path, revision, callback) {
      fetchSql(path, revision, callback);
    }
  }

}();

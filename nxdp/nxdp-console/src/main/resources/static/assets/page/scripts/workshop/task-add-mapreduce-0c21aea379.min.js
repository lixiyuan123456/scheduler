var TaskAdd = function () {
    var e = $(this);
    $.ajaxSetup({async: !1}), String.prototype.startWith = function (e) {
        var t = new RegExp("^" + e);
        return t.test(this)
    }, String.prototype.endWith = function (e) {
        var t = new RegExp(e + "$");
        return t.test(this)
    };
    var t = function (e) {
        return "" == e || null == e || void 0 == e ? !0 : !1
    }, r = function () {
        e.userList = new Array, $.post(e.contextPath + "/user/api/list-user", function (t, r) {
            _.each(t.userList, function (t) {
                return e.userId == t.id ? void e.userList.push({
                    id: t.id,
                    text: t.trueName + "-" + t.userName,
                    selected: !0
                }) : void e.userList.push({id: t.id, text: t.trueName + "-" + t.userName, selected: !1})
            }), $("#selUser").select2({
                language: {
                    noResults: function () {
                        return "无搜索结果"
                    }
                }, placeholder: "选择用户", data: e.userList
            }).on("change", function (e) {
            }), $("#selUser").val(e.userId).trigger('change')
        })
    }, a = function () {
        e.receiverList = new Array, $.post(e.contextPath + "/user/api/list-user", function (t, r) {
            _.each(t.userList, function (t) {
                return e.userId == t.id ? void e.receiverList.push({
                    id: t.id,
                    text: t.trueName+"(" + t.userName +")",
                    selected: !0
                }) : void e.receiverList.push({id: t.id, text: t.trueName+"(" + t.userName +")", selected: !1})
            }), $("#receiver").select2({data: e.receiverList,multiple:true,}), $("#receiver").val(e.userId).trigger('change');
        })
    }, i = function () {
        var t;
        $("#hidType").val();
        t = {
            serverType: 2,
            localType: 2
        }, e.serverList = new Array, $.post(e.contextPath + "/dev/task/api/list-hdp-clusters", t, function (t, r) {
            _.each(t.serverConfig, function (t) {
                e.serverList.push({id: t.id, text: t.clusterName, selected: !1})
            }), $("#server").select2({
                language: {
                    noResults: function () {
                        return "无搜索结果"
                    }
                }, placeholder: "选择服务器", data: e.serverList
            }).on("change", function (e) {
            }),
            $("#server").select2({data: e.serverList}), $("#server").val('2').trigger('change');
        })
    }, n = function () {
        $.ajaxSetup({async: !0}),
        $("#jobFile").fileinput({
            language: "zh",
            showPreview: !1,
            showUpload: !0,
            uploadAsync: !0,
            uploadUrl: e.contextPath + "/dev/task/uploadFile",
            allowedFileExtensions: ["jar", "py", "sh"],
            elErrorContainer: "#errorBlock"
        }),
        $("#jobFile").on("fileuploaded", function (e, t) {
            var r = t.response;
            "true" == r.result ? ($("#filePath").val(r.filePath), $("#fileName").val(r.fileName), $("#newFileName").val(r.newFileName), s(), toastr.success("文件上传成功.", "提示"), $("#fileUploadState").html(r.fileName + " 上传成功"), $("#uploadFlag").val(1)) : "tooBig" == r.result ? (toastr.error("上传文件太大,请重新新上传", "错误"), $("#uploadFlag").val(0)) : (toastr.error(r.errorMsg, "错误"), $("#uploadFlag").val(0))
        })
    }, s = function () {
        $("#checkDefaultName").is(":checked") && $("#jobName").val(o())
    }, o = function () {
        var e = $("#fileName").val();
        if (!e) return "";
        var t = e.lastIndexOf("/");
        return -1 != t && (e = e.substring(t + 1)), e = e.endWith(".jar") ? e.replace(".jar", "") : $.trim(e.split(/\./)[0])
    }, l = function () {
        var e = $("#taskConfig"), t = $(".alertInfo"), r = $(".alert-danger", t), a = $(".alert-success", t);
        e.validate({
            errorElement: "span",
            errorClass: "help-block help-block-error",
            focusInvalid: !1,
            ignore: "",
            rules: {
                jobName: {required: !0},
                description: {required: !0},
                server: {required: !0},
                hadoopQueue: {required: !0}
            },
            messages: {
                membership: {required: "Please select a Membership type"},
                service: {
                    required: "Please select  at least 2 types of Service",
                    minlength: jQuery.validator.format("Please select  at least {0} types of Service")
                }
            },
            errorPlacement: function (e, t) {
                t.parent(".input-group").size() > 0 ? e.insertAfter(t.parent(".input-group")) : t.attr("data-error-container") ? e.appendTo(t.attr("data-error-container")) : t.parents(".radio-list").size() > 0 ? e.appendTo(t.parents(".radio-list").attr("data-error-container")) : t.parents(".radio-inline").size() > 0 ? e.appendTo(t.parents(".radio-inline").attr("data-error-container")) : t.parents(".checkbox-list").size() > 0 ? e.appendTo(t.parents(".checkbox-list").attr("data-error-container")) : t.parents(".checkbox-inline").size() > 0 ? e.appendTo(t.parents(".checkbox-inline").attr("data-error-container")) : e.insertAfter(t)
            },
            invalidHandler: function (e, t) {
                a.hide(), r.show(), Metronic.scrollTo(r, -200)
            },
            highlight: function (e) {
                $(e).closest(".form-group").addClass("has-error")
            },
            unhighlight: function (e) {
                $(e).closest(".form-group").removeClass("has-error")
            },
            success: function (e) {
                e.closest(".form-group").removeClass("has-error")
            },
            submitHandler: function (e) {
                a.show(), r.hide(), e.submit()
            }
        })
    }, c = function () {
        $("#checkDefaultName").iCheck("check")
    }, d = function () {
        return e.editing = !!$("#hidId").val(), e.editing ? void $.ajax({
            type: "POST",
            url: e.contextPath + "/dev/task/api/fetch-task",
            data: {id: $("#hidId").val()},
            success: function (t) {
                "ok" == t.status ? (e.task = t.task, u()) : toastr.error("获取任失败.", "提示")
            },
            error: function () {
                toastr.error("获取任务失败.", "提示")
            }
        }) : ($("#taskTitle").html("新建MR脚本"), void c())
    }, u = function () {
        console.log(e.task);
        writeRelationDataBack(e.task);
        var t = $.parseJSON(e.task.details);
        $("#jobName").val(e.task.jobName), $("#description").val(e.task.description), $("#hidType").val(e.task.type), $("#taskTitle").html("修改MR脚本"), $("#server").val(t.serverId).trigger("change"), $("#selUser").val(e.task.userId).trigger('change'), $("#receiver").val(t.receiver).trigger('change'), $("#filePath").val(t.filePath), $("#fileName").val(t.fileName), $("#fileUploadState").html(t.fileName), $("#newFileName").val(t.newFileName), $("#jobPackage").val(t.jobPackage), $("#inputPath").val(t.inputPath), $("#outputPath").val(t.outputPath), $("#otherArgs").val(t.otherArgs), $("#jobName").val() == o() && c();
        var r = t.scheduler;
        t.dependencies;
        e.taskScheduler.loadScheduler(r)
    }, h = function () {
        $("#viewTask").click(function () {
            e.editing ? (e.viewJobUrl = e.contextPath + "/scheduler/task/detail?schedulerId=" + $("#hidId").val(), window.location.href = e.viewJobUrl) : toastr.error("任务不存在.", "提示")
        }), $("#saveTask").click(function () {
            var r = function (e) {
                return toastr.error(e, "提示"), !1
            }, a = function (e) {
                return $.trim($(e).val())
            }, i = a("#jobName"), n = a("#fileName");
            if (t(n)) return r("文件未上传或者上传失败"), !1;
            var s = {
                "jobName": i,
                "type": $("#hidType").val(),
                "userId": a("#selUser"),
                "description": $("#description").val(),
                'outputMode': $('#taskConfig input[name="outputMode"]:checked').val(),
                'outputModeValue': $('#taskConfig input[name="outputMode"]:checked').val() == 1 ? JSON.stringify($('#taskConfig select[name="outputModeValue"]').val()) : $('#taskConfig input[name="outputModeValue"]').val(),
            };
            if (!$("#taskConfig").validate().form()) return !1;
            if (!$("#scheduleConfig").validate().form()) return !1;
            var o = {};
            $.extend(o, {
                fileName: a("#fileName"),
                newFileName: a("#newFileName"),
                filePath: a("#filePath"),
                uploadFlag: a("#uploadFlag"),
                jobPackage: a("#jobPackage"),
                serverId: a("#server"),
                out: packRelationData(),
            }), $.extend(o, {inputPath: a("#inputPath"), outputPath: a("#outputPath"), otherArgs: a("#otherArgs")});
            var l = e.taskScheduler.validateScheduler(), c = $("#dependencyJobIds").val();
            $.extend(o, {
                scheduler: l,
                dependencies: c
            }), s["details"] = JSON.stringify(o), e.editing && (s["id"] = $("#hidId").val()), console.log(s), $.post(e.contextPath + "/dev/task/api/save-file-job", s, function (t) {
                return "ok" != t.status ? void toastr.error(t.msg) : (toastr.success(e.editing ? "修改成功" : "保存成功", "提示"), e.editing || ($("#hidId").val(t.id), e.editing = !0), void v())
            }, "json")
        })
    }, p = function () {
        var t = $("#tblHistory");
        e.tblHistory = t.DataTable({
            bProcessing: !0,
            language: {
                emptyTable: "无结果",
                lengthMenu: "每页&nbsp; _MENU_ &nbsp;项",
                search: "查找：",
                processing: "正在加载...",
                info: "显示 _START_ 到 _END_ 共 _TOTAL_ 条记录",
                infoEmpty: "显示  0  到  0 共  0 条记录"
            },
            info: !1,
            ordering: !1,
            paging: !1,
            searching: !1,
            serverSide: !1,
            ajax: {
                url: e.contextPath + "/dev/task/api/fetch-file-history", type: "POST", data: function (e) {
                    e.columns = null, e.search = null, e.id = $("#hidId").val()
                }, dataSrc: function (e) {
                    return e.list || (e.list = []), e.list
                }
            },
            columns: [{data: "updateTime"}, {data: "operatorName"}, {data: "fileName"}, {
                data: null,
                render: function (t, r, a, i) {
                    var n = e.contextPath + "/dev/task/downloadFile?fileName=" + t.filepath + "&realFileName=" + t.fileName;
                    return '<a href="' + n + '" class="downloadInNewWindow">下载</a>'
                }
            }]
        }), $("#tblHistory_processing").hide();
        jQuery("#tblHistory_wrapper")
    }, v = function () {
        e.tblHistory.ajax.reload()
    };
    return {
        init: function (t) {
            e.contextPath = t.contextPath, e.userId = t.userId, e.taskScheduler = t.taskScheduler, r(), a(), n(), i(), l(), d(), p(), h()
        }, fetchSql: function (e, t, r) {
            fetchSql(e, t, r)
        }
    }
}();
//# sourceMappingURL=task-add-mapreduce-0c21aea379.min.js.map
